// prisma/schema.prisma
// VibeCoding Platform - Database Schema
// Version: 1.0
// Last Updated: 28 Nov 2025

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  OWNER
  ADMIN
  MEMBER
}

enum AppType {
  SAAS_B2B
  SAAS_B2C
  MOBILE_APP
  CHROME_EXTENSION
  API_BACKEND
}

enum ProjectStatus {
  GENERATING
  ACTIVE
  ARCHIVED
}

enum PhaseStatus {
  LOCKED
  UNLOCKED
  IN_PROGRESS
  COMPLETED
}

enum ChecklistItemStatus {
  PENDING
  COMPLETED
}

enum ExportFileType {
  CURSORRULES
  PRD_MD
  CONTEXT_MD
  ARCHITECTURE_MD
  PHASES_MD
  MINDMAP_PNG
}

// ============================================
// MODELS
// ============================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users    User[]
  projects Project[]

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  clerkId        String   @unique
  email          String
  name           String
  avatarUrl      String?
  role           UserRole @default(MEMBER)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdProjects Project[]    @relation("ProjectCreator")

  @@index([clerkId])
  @@index([organizationId])
  @@map("users")
}

model Project {
  id             String        @id @default(uuid())
  name           String
  description    String?       @db.Text
  ideaSummary    String        @db.Text
  appType        AppType
  targetUsers    String        @db.Text
  status         ProjectStatus @default(GENERATING)
  organizationId String
  createdById    String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("ProjectCreator", fields: [createdById], references: [id])
  phases       Phase[]
  exports      Export[]

  @@index([organizationId])
  @@index([status])
  @@map("projects")
}

model Phase {
  id                 String      @id @default(uuid())
  projectId          String
  phaseNumber        Int
  phaseName          String
  status             PhaseStatus @default(LOCKED)
  progressPercentage Int         @default(0)
  generatedContent   Json?       @db.JsonB
  unlockedAt         DateTime?
  completedAt        DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  checklistItems ChecklistItem[]

  @@unique([projectId, phaseNumber])
  @@index([projectId])
  @@index([status])
  @@map("phases")
}

model ChecklistItem {
  id            String              @id @default(uuid())
  phaseId       String
  title         String
  description   String              @db.Text
  status        ChecklistItemStatus @default(PENDING)
  required      Boolean             @default(true)
  estimatedTime String
  userInput     Json?               @db.JsonB
  orderIndex    Int
  completedAt   DateTime?
  createdAt     DateTime            @default(now())

  phase Phase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@index([status])
  @@map("checklist_items")
}

model Export {
  id          String         @id @default(uuid())
  projectId   String
  fileType    ExportFileType
  fileContent String         @db.Text
  fileUrl     String?
  generatedAt DateTime       @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([fileType])
  @@map("exports")
}

// ============================================
// NOTES
// ============================================

// Multi-Tenancy : Toutes les queries doivent filtrer par organizationId
// Row Level Security (RLS) : Implémenté dans Supabase
// Indexes : Ajoutés sur toutes les foreign keys et colonnes fréquemment queryed
// JSON Fields : Utilisés pour flexibility (generatedContent, userInput)
// Soft Deletes : Pas implémentés en MVP (hard delete via CASCADE)
